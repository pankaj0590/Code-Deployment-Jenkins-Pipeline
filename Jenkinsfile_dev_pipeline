node {
	def RepositoryName  = params.MicroService
    def Branch = params.BranchName
	  currentBuild.displayName = RepositoryName + " # ${env.BUILD_ID}"
    def mvnHome = tool 'M3'
    def javaHome = tool 'java1.8'
   	clean()
   	checkoutProject(RepositoryName,Branch)
   	build(RepositoryName)
    dockerImage(RepositoryName)
    dockerPush(RepositoryName)
    deployToEcs(RepositoryName)
}

def checkoutProject(RepositoryName,Branch){
   stage('Project code pull from GitHub'){
      	if(RepositoryName.equalsIgnoreCase("helloservice")){
			   checkout([$class: 'GitSCM',branches:[[name: Branch]], doGenerateSubmoduleConfigurations: false, extensions: [[$class:'CloneOption', depth: 0, noTags: false, reference: '', shallow: false, timeout: 60]], gitTool: 'Default', submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/pankaj0590/spring-boot-hello-world.git' ]]])
      	}else{
			echo "Invalid Repository"
	  	}
   }
}

def build(RepositoryName) {
  stage('Maven Build'){
   withEnv(['PATH+EXTRA=/usr/java/jdk1.8.0_141/bin:/sbin:/usr/sbin:/bin:/usr/bin:/usr/local/src/apache-maven/bin']) {
	echo "Build Step"
        def mvnHome = tool 'M3'
        def javaHome = tool 'java1.8'
    
        //sh 'chmod -R +x ./scripts/*'
      	sh "$mvnHome/bin/mvn -version"
        sh "$mvnHome/bin/mvn clean install"
        sh "$mvnHome/bin/mvn  jar:jar install:install"
        //sh "$mvnHome/bin/mvn surefire-report:report-only"
        //sh "mvn site -DgenerateReports=false"
        echo "This is maven build"
    }
    }
  }


def dockerImage (RepositoryName) {
	stage ('Create Docker Image') {
	echo "Create Docker Image"
	if(RepositoryName.equalsIgnoreCase("helloservice")){
		docker.build("dev-spring-boot-hello-world" ,"-f Dockerfile.build .")
	}
   }
}
def dockerPush(RepositoryName){
   stage ('Docker Image push to ECR') {
	echo "Docker Image push to ECR"
	if(RepositoryName.equalsIgnoreCase("helloservice")){
		docker.withRegistry('https://757681645441.dkr.ecr.us-east-1.amazonaws.com/dev-spring-boot-hello-world', 'ecr:us-east-1:dev_user') {
                docker.image('dev-spring-boot-hello-world').push('latest')
		}
		
	}
   }
}


def deployToEcs(RepositoryName) {
	stage ('Deploy the service on AWS ECS Cluster') {
	         def buildenv = docker.image('cloudbees/java-build-tools:0.0.7.1')
  buildenv.inside {
    wrap([$class: 'AmazonAwsCliBuildWrapper', credentialsId: 'dev_user', defaultRegion: 'us-east-1']) {
        sh "aws ecs update-service --service spring-boot-hello-world-service  --cluster aws-fargate-cluster --desired-count 0"
        timeout(time: 5, unit: 'MINUTES') {
            waitUntil {
                sh "aws ecs describe-services --services spring-boot-hello-world-service  --cluster aws-fargate-cluster  > .amazon-ecs-service-status.json"

                // parse `describe-services` output
                def ecsServicesStatusAsJson = readFile(".amazon-ecs-service-status.json")
                def ecsServicesStatus = new groovy.json.JsonSlurper().parseText(ecsServicesStatusAsJson)
                println "$ecsServicesStatus"
                def ecsServiceStatus = ecsServicesStatus.services[0]
                return ecsServiceStatus.get('runningCount') == 0 && ecsServiceStatus.get('status') == "ACTIVE"
            }
        }
        sh "aws ecs update-service --service spring-boot-hello-world-service  --cluster aws-fargate-cluster --desired-count 1"
        timeout(time: 5, unit: 'MINUTES') {
            waitUntil {
                sh "aws ecs describe-services --services spring-boot-hello-world-service --cluster aws-fargate-cluster > .amazon-ecs-service-status.json"

                // parse `describe-services` output
                def ecsServicesStatusAsJson = readFile(".amazon-ecs-service-status.json")
                def ecsServicesStatus = new groovy.json.JsonSlurper().parseText(ecsServicesStatusAsJson)
                println "$ecsServicesStatus"
                def ecsServiceStatus = ecsServicesStatus.services[0]
                return ecsServiceStatus.get('runningCount') == 0 && ecsServiceStatus.get('status') == "ACTIVE"
            }
        }
        timeout(time: 5, unit: 'MINUTES') {
            waitUntil {
                try {
                    //sh "curl http://52.200.92.100:80"
                    return true
                } catch (Exception e) {
                    return false
                }
            }
        }
	}
        //echo RepositoryName + " # ${env.BUILD_ID} SUCCESSFULLY deployed to http://52.200.92.100:80"
        // input 'Does staging http://52.200.92.100:80 look okay?'
}
}

def clean() {
    stage ('Clean WorkSpace') {
        cleanWs()
        sh 'pwd'
        sh 'ls'
    }
}
